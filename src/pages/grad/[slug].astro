---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import NavTabs from '../../components/NavTabs.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import StatCard from '../../components/StatCard.astro';
import BarChart from '../../components/BarChart.astro';
import SurnameList from '../../components/SurnameList.astro';
import PopulationChange from '../../components/PopulationChange.astro';
import AdUnit from '../../components/AdUnit.astro';
import WikiDescription from '../../components/WikiDescription.astro';
import LocationMeta from '../../components/LocationMeta.astro';
import CoatOfArms from '../../components/CoatOfArms.astro';
import Conclusions from '../../components/Conclusions.astro';
import { GRADOVI } from '../../data/gradovi';
import { ZUPANIJE } from '../../data/zupanije';
import wikiData from '../../data/wiki-enrichment.json';

export function getStaticPaths() {
  return GRADOVI.map(g => ({
    params: { slug: g.slug },
    props: { grad: g }
  }));
}

const { grad } = Astro.props;
const zupanija = ZUPANIJE.find(z => z.id === grad.county_id);
const wiki = (wikiData as Record<string, any>)[grad.slug] || {};
const similarCities = GRADOVI
  .filter(g => g.county_id === grad.county_id && g.slug !== grad.slug)
  .sort((a, b) => Math.abs(a.population_2021 - grad.population_2021) - Math.abs(b.population_2021 - grad.population_2021))
  .slice(0, 5);

const schema = {
  "@context": "https://schema.org",
  "@type": "City",
  "name": grad.name,
  "containedInPlace": {
    "@type": "AdministrativeArea",
    "name": grad.county_name
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": grad.lat,
    "longitude": grad.lng
  },
  "population": {
    "@type": "QuantitativeValue",
    "value": grad.population_2021,
    "unitText": "inhabitants",
    "observationDate": "2021-09-13"
  }
};

const title = `${grad.name} â€” broj stanovnika, demografija, prezimena`;
const description = `${grad.name}: ${grad.population_2021.toLocaleString('hr-HR')} stanovnika (Popis 2021). Demografski podaci, dobna struktura, najcesca prezimena, obrazovanje, nacionalni sastav.`;
---

<Layout title={title} description={description} schema={schema} article>
  <Header />
  <NavTabs active="gradovi" />

  <main class="max-w-4xl mx-auto px-4 py-6">
    <Breadcrumb items={[
      { label: zupanija?.name || grad.county_name, href: `/zupanija/${grad.county_slug}/` },
      { label: grad.name }
    ]} />

    <div class="flex items-center gap-3 mb-1">
      <CoatOfArms src={wiki.coatOfArms} alt={grad.name} />
      <div>
        <h1 class="text-2xl font-black text-gray-100">{grad.name}</h1>
        <p class="text-sm text-gray-500">Grad &middot; {grad.county_name}</p>
      </div>
    </div>

    {(wiki.photo || wiki.thumbnail) && (
      <div class="mb-6 mt-4">
        <img
          src={wiki.photo || wiki.thumbnail}
          alt={grad.name}
          loading="lazy"
          class="w-full max-h-64 object-cover rounded-lg"
        />
      </div>
    )}

    {!(wiki.photo || wiki.thumbnail) && <div class="mb-6"></div>}

    <WikiDescription description={wiki.description} locationName={grad.name} />

    <LocationMeta
      postalCode={wiki.postalCode}
      elevation={wiki.elevation}
      licensePlate={wiki.licensePlate}
      officialWebsite={wiki.officialWebsite}
    />

    <!-- Key Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
      <StatCard value={grad.population_2021} label="Stanovnika" change={grad.change_pct} />
      <StatCard value={`${grad.area_km2.toFixed(1)} km2`} label="Povrsina" />
      <StatCard value={grad.density.toFixed(1)} label="Gustoca (stan/km2)" />
      <StatCard value={grad.avg_age.toFixed(1)} label="Prosjecna starost" />
      <StatCard value={`${grad.male_pct.toFixed(1)}%`} label="Muski" />
      <StatCard value={`${grad.female_pct.toFixed(1)}%`} label="Zenski" />
    </div>

    <!-- Age Pyramid -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Dobna struktura</h2>
      <BarChart items={[
        { label: '0-14 godina', value: grad.age_0_14_pct, color: '#22c55e' },
        { label: '15-64 godina', value: grad.age_15_64_pct, color: '#3b82f6' },
        { label: '65+ godina', value: grad.age_65_plus_pct, color: '#ef4444' },
      ]} maxValue={100} />
    </section>

    <!-- Nationality -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Nacionalni sastav</h2>
      <BarChart items={[
        { label: 'Hrvati', value: grad.nationality_croatian_pct, color: '#3b82f6' },
        { label: 'Srbi', value: grad.nationality_serbian_pct, color: '#64748b' },
        { label: 'Ostali', value: grad.nationality_other_pct, color: '#475569' },
      ]} maxValue={100} />
    </section>

    <!-- Religion -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Vjeroispovijest</h2>
      <BarChart items={[
        { label: 'Katolici', value: grad.religion_catholic_pct, color: '#3b82f6' },
        { label: 'Pravoslavci', value: grad.religion_orthodox_pct, color: '#64748b' },
        { label: 'Ostali', value: grad.religion_other_pct, color: '#475569' },
      ]} maxValue={100} />
    </section>

    <AdUnit />

    <!-- Education -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Obrazovanje (15+)</h2>
      <BarChart items={[
        { label: 'Fakultet', value: grad.education_university_pct, color: '#22c55e' },
        { label: 'Srednja skola', value: grad.education_secondary_pct, color: '#3b82f6' },
        { label: 'Osnovna skola', value: grad.education_primary_pct, color: '#f97316' },
      ]} maxValue={100} />
    </section>

    <!-- Surnames -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Najcesca prezimena</h2>
      <SurnameList surnames={grad.top_surnames} />
    </section>

    <!-- Housing -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Stanovanje</h2>
      <div class="grid grid-cols-2 gap-3">
        <StatCard value={grad.housing_total} label="Ukupno stanova" />
        <StatCard value={`${grad.housing_occupied_pct.toFixed(1)}%`} label="Nastanjeno" />
      </div>
    </section>

    <!-- Population Change -->
    <section class="mb-6">
      <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Promjena stanovnistva 2011 &rarr; 2021</h2>
      <div class="bg-gray-900 rounded-lg p-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="text-xs text-gray-500">Popis 2011.</div>
            <div class="text-lg font-bold text-gray-300">{grad.population_2011.toLocaleString('hr-HR')}</div>
          </div>
          <PopulationChange change={grad.change_pct} large />
          <div class="text-right">
            <div class="text-xs text-gray-500">Popis 2021.</div>
            <div class="text-lg font-bold text-gray-300">{grad.population_2021.toLocaleString('hr-HR')}</div>
          </div>
        </div>
      </div>
    </section>

    <AdUnit />

    <Conclusions conclusions={wiki.conclusions} />

    <!-- Sister Cities -->
    {wiki.sisterCities && wiki.sisterCities.length > 0 && (
      <section class="mb-6">
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Gradovi prijatelji</h2>
        <div class="flex flex-wrap gap-2">
          {wiki.sisterCities.map((city: string) => (
            <span class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm text-gray-300">
              {city}
            </span>
          ))}
        </div>
      </section>
    )}

    <!-- Similar Cities -->
    {similarCities.length > 0 && (
      <section class="mb-6">
        <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Slicni gradovi</h2>
        <div class="flex flex-wrap gap-2">
          {similarCities.map(city => (
            <a href={`/grad/${city.slug}/`} class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm text-blue-400 hover:border-blue-500 transition-colors no-underline">
              {city.name} ({city.population_2021.toLocaleString('hr-HR')})
            </a>
          ))}
        </div>
      </section>
    )}
  </main>
</Layout>
